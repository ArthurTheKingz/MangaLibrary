{% extends "base.html" %}
{% import "_pagination.html" as macros %}

{% block page_content %}
<div class="d-flex">
    <div class="container ps-0 d-flex flex-column" style="width: 250px;">
        <img src="{{ manga.image_url() }}" alt="...">
        {% if current_user.is_authenticated and current_user.can(Permission.FOLLOW) %}
            {% if not current_user.is_reading(manga) %}
                <a href="{{ url_for('.follow', id = manga.id) }}"  type="button" class="btn btn-manga-subscribe mt-2">
                    Начать читать
                </a>
            {% else %}
                <a href="{{ url_for('.unfollow', id = manga.id) }}" type="button" class="btn btn-danger mt-2">Перестать читать</a>
            {% endif %}
        {% endif %}
    </div>
    <div class="card-body p-0">
        <h5 class="card-title">{{ manga.title }}</h5>
        <p class="card-text">{{ manga.catalog }}</p>
        {% if manga.tags.count() %}
            {% for tag in manga.tags %}
                <a type="button" href="{{ url_for('manga.tag', id = tag.id) }}" class="btn btn-light mb-2">{{ tag.name }}</a>
            {% endfor %}
        {% endif %}
        {% if manga.author %}
            <p class="card-text"><small class="text-muted">Автор: {{ manga.author }}</small></p>
        {% endif %}
        <p class="card-text"><small class="text-muted">Обновлено: {{ moment(manga.timestamp).fromNow() }}</small></p>
        {% if manga.user.id %}
            <p class="card-text"><small class="text-muted">Обновил: <a href="{{ url_for('user.index', id = manga.user.id) }}">{{ manga.user.username }}</a></small></p>
        {% endif %}
        <p class="card-text"><small class="text-muted">Читают: {{ manga.users.count() }}</small></p>
        {% if current_user.is_authenticated and current_user.can(Permission.PUBLICATION) %}
            <div class="d-flex my-2 justify-content-center">
                <a  type="button" href="{{ url_for('.edit', id = manga.id) }}" class="btn btn-primary mt-2">Редактировать</a>
            </div>
        {% endif %}
        {% if manga.chapter.count() %}
        <h6>Главы:</h6>
        {% endif %}
            {% for chapter in manga.chapter.all() %}
                <div class="d-flex mb-1">
                    <a href="{{ url_for('manga.chapter', id = manga.id, volume = chapter.volume, chapter = chapter.chapter) }}" type="button" class="list-group-item list-group-item-action">
                        Том {{ chapter.volume }} Глава {{ chapter.chapter }} {{ chapter.title}} 
                    </a>
                    {% if current_user.is_authenticated and current_user.can(Permission.PUBLICATION) %}
                    <a href="{{ url_for('manga.delete_chapter', id = manga.id, volume = chapter.volume, chapter = chapter.chapter) }}" type="button" class="btn btn-danger chapter-delete">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M13.854 2.146a.5.5 0 0 1 0 .708l-11 11a.5.5 0 0 1-.708-.708l11-11a.5.5 0 0 1 .708 0Z"/>
                            <path fill-rule="evenodd" d="M2.146 2.146a.5.5 0 0 0 0 .708l11 11a.5.5 0 0 0 .708-.708l-11-11a.5.5 0 0 0-.708 0Z"/>
                        </svg>
                    </a>
                    {% endif %}
                </div>
            {% endfor %}
        {% if current_user.is_authenticated and current_user.can(Permission.PUBLICATION) %}
            <div class="d-flex mt-2 justify-content-center">
                <a  type="button" href="{{ url_for('manga.add_chapter', id = manga.id) }}" class="btn btn-primary mt-2">Добавить главу</a>
            </div>
        {% endif %}
        <h6 class="mb-3 mt-4">Комментарии:</h6>
        {% if current_user.is_authenticated and current_user.can(Permission.COMMENT)%}
            <form action="{{ url_for('comment.add_manga_comment', id=manga.id) }}" method="post">
                {{ comment_form.hidden_tag() }}
                {{ comment_form.comment(class_="form-control", placeholder="Комментарий") }}
                <div class="d-flex justify-content-end my-2">
                    {{ comment_form.submit(class_="btn btn-primary px-3") }}
                </div>
            </form>
        {% endif %}
        {% include '_comments.html' %}

        {% if pagination and pagination.pages > 1 %}
        {{ macros.widget(pagination, '.index', id=manga.id) }}
        {% endif %}
{% endblock %}